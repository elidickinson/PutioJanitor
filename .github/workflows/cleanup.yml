
name: Put.io Janitor

on:
  schedule:
    - cron: '0 10 * * *'  # Run daily at 5:00 AM Eastern Time (10:00 UTC)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode'
        required: true
        type: boolean
        default: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tus.py

      - name: Run Put.io Janitor
        id: cleanup
        env:
          PUTIO_TOKEN: ${{ secrets.PUTIO_TOKEN }}
          # Optional environment variables (uncomment and modify as needed)
          # PUTIO_SPACE_THRESHOLD_GB: "10"
          # PUTIO_TRASH_CLEANUP_THRESHOLD_GB: "5"
          # PUTIO_TRASH_CLEANUP_TARGET_GB: "5"
          # PUTIO_MIN_TRASH_AGE_DAYS: "2"
          # PUTIO_DELETABLE_FOLDERS: "chill.institute,putfirst"
          # PUTIO_MAX_RETRIES: "3"
          # PUTIO_RETRY_DELAY: "5"
        run: |
          # Set dry run mode based on inputs
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            export PUTIO_DRY_RUN=true
          fi
          
          # Run script and capture output
          OUTPUT=$(python putio_janitor.py)
          
          # Extract key information from output
          DELETED_FILES=$(echo "$OUTPUT" | grep " -   - " || echo "")
          SUMMARY_LINE=$(echo "$OUTPUT" | grep "Deleted [0-9]* files/folders, freed" || echo "")
          NO_CLEANUP=$(echo "$OUTPUT" | grep "No cleanup needed" || echo "")
          
          # Count deleted files
          if [ -n "$DELETED_FILES" ]; then
            FILES_COUNT=$(echo "$DELETED_FILES" | wc -l)
          else
            FILES_COUNT=0
          fi
          
          # Create a simple summary
          echo "### Storage Cleanup Summary" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Type:** ${{ github.event.inputs.dry_run && 'Dry Run' || 'Production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "$NO_CLEANUP" ]; then
            echo "✅ No cleanup needed - sufficient free space available" >> $GITHUB_STEP_SUMMARY
          elif [ "$FILES_COUNT" -gt 0 ]; then
            echo "**Files Deleted:** $FILES_COUNT" >> $GITHUB_STEP_SUMMARY
            if [ -n "$SUMMARY_LINE" ]; then
              echo "**Result:** $SUMMARY_LINE" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Deleted Files:**" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$DELETED_FILES" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Script ran but no files were processed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Set outputs for job summary
          if [ "$FILES_COUNT" -gt 0 ]; then
            echo "deleted_files=true" >> $GITHUB_OUTPUT
          else
            echo "deleted_files=false" >> $GITHUB_OUTPUT
          fi
          
          # Show full script output for debugging
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Script Output:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Exit with original output
          echo "$OUTPUT"
