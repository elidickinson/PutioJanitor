
name: Put.io Janitor

on:
  schedule:
    - cron: '0 10 * * *'  # Run daily at 5:00 AM Eastern Time (10:00 UTC)
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode'
        required: true
        type: boolean
        default: false

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests tus.py

      - name: Run Put.io Janitor
        id: cleanup
        env:
          PUTIO_TOKEN: ${{ secrets.PUTIO_TOKEN }}
          # Optional environment variables (uncomment and modify as needed)
          # PUTIO_SPACE_THRESHOLD_GB: "10"
          # PUTIO_TRASH_CLEANUP_THRESHOLD_GB: "5"
          # PUTIO_TRASH_CLEANUP_TARGET_GB: "5"
          # PUTIO_MIN_TRASH_AGE_DAYS: "2"
          # PUTIO_DELETABLE_FOLDERS: "chill.institute,putfirst"
          # PUTIO_MAX_RETRIES: "3"
          # PUTIO_RETRY_DELAY: "5"
        run: |
          # Set dry run mode based on inputs
          if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
            export PUTIO_DRY_RUN=true
          fi

          # Run script and capture output
          python putio_janitor.py 2>&1 | tee output.log
          OUTPUT=$(cat output.log)

          # Create summary header
          echo "### ðŸ§¹ Put.io Storage Cleanup" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Type:** ${{ github.event.inputs.dry_run == 'true' && 'Dry Run ðŸ§ª' || 'Production ðŸš€' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Filter and display the relevant output (remove timestamps and log levels for cleaner display)
          echo "### Output" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUT" | sed -E 's/^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2} - (INFO|WARNING|ERROR|DEBUG) - //' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
